<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GraphvizImageBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.svek</a> &gt; <span class="el_source">GraphvizImageBuilder.java</span></div><h1>GraphvizImageBuilder.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2024, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 * 
 * If you like this project or if you find it useful, you can support us at:
 * 
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 * 
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 * Contribution :  Hisashi Miyashita
 * Contribution :  Serge Wenger
 * 
 *
 */
package net.sourceforge.plantuml.svek;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import net.atmp.InnerStrategy;
import net.sourceforge.plantuml.StringUtils;
import net.sourceforge.plantuml.abel.Entity;
import net.sourceforge.plantuml.abel.GroupType;
import net.sourceforge.plantuml.abel.LeafType;
import net.sourceforge.plantuml.abel.Link;
import net.sourceforge.plantuml.core.UmlSource;
import net.sourceforge.plantuml.crash.GraphvizCrash;
import net.sourceforge.plantuml.decoration.symbol.USymbolHexagon;
import net.sourceforge.plantuml.dot.DotData;
import net.sourceforge.plantuml.dot.ExeState;
import net.sourceforge.plantuml.dot.GraphvizRuntimeEnvironment;
import net.sourceforge.plantuml.dot.GraphvizUtils;
import net.sourceforge.plantuml.dot.UnparsableGraphvizException;
import net.sourceforge.plantuml.klimt.color.HColor;
import net.sourceforge.plantuml.klimt.drawing.UGraphic;
import net.sourceforge.plantuml.klimt.font.FontConfiguration;
import net.sourceforge.plantuml.klimt.font.StringBounder;
import net.sourceforge.plantuml.klimt.geom.MagneticBorder;
import net.sourceforge.plantuml.klimt.geom.MagneticBorderNone;
import net.sourceforge.plantuml.klimt.geom.MinMax;
import net.sourceforge.plantuml.klimt.geom.XDimension2D;
import net.sourceforge.plantuml.klimt.geom.XRectangle2D;
import net.sourceforge.plantuml.klimt.shape.GraphicStrings;
import net.sourceforge.plantuml.log.Logme;
import net.sourceforge.plantuml.security.SecurityProfile;
import net.sourceforge.plantuml.security.SecurityUtils;
import net.sourceforge.plantuml.skin.Pragma;
import net.sourceforge.plantuml.skin.PragmaKey;
import net.sourceforge.plantuml.skin.SkinParam;
import net.sourceforge.plantuml.skin.UmlDiagramType;
import net.sourceforge.plantuml.stereo.Stereotype;
import net.sourceforge.plantuml.style.ISkinParam;
import net.sourceforge.plantuml.style.PName;
import net.sourceforge.plantuml.style.SName;
import net.sourceforge.plantuml.style.Style;
import net.sourceforge.plantuml.style.StyleSignature;
import net.sourceforge.plantuml.style.StyleSignatureBasic;
import net.sourceforge.plantuml.svek.image.EntityImageClass;
import net.sourceforge.plantuml.svek.image.EntityImageNote;
import net.sourceforge.plantuml.text.BackSlash;
import net.sourceforge.plantuml.utils.Log;

public final class GraphvizImageBuilder {

	private final DotData dotData;
	private final DotMode dotMode;

	private final UmlSource source;
	private final Pragma pragma;
	private Map&lt;String, Double&gt; maxX;

	private final SName styleName;
	private final DotStringFactory dotStringFactory;
	private final ClusterManager clusterManager;

	public GraphvizImageBuilder(DotData dotData, UmlSource source, Pragma pragma, SName styleName, DotMode dotMode,
<span class="fc" id="L106">			DotStringFactory dotStringFactory, ClusterManager clusterManager) {</span>
<span class="fc" id="L107">		this.dotData = dotData;</span>
<span class="fc" id="L108">		this.dotMode = dotMode;</span>
<span class="fc" id="L109">		this.styleName = styleName;</span>
<span class="fc" id="L110">		this.source = source;</span>
<span class="fc" id="L111">		this.pragma = pragma;</span>
<span class="fc" id="L112">		this.dotStringFactory = dotStringFactory;</span>
<span class="fc" id="L113">		this.clusterManager = clusterManager;</span>

<span class="fc" id="L115">	}</span>

	final public StyleSignature getDefaultStyleDefinitionArrow(Stereotype stereotype) {
<span class="nc" id="L118">		StyleSignature result = StyleSignatureBasic.of(SName.root, SName.element, styleName, SName.arrow);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (stereotype != null)</span>
<span class="nc" id="L120">			result = result.withTOBECHANGED(stereotype);</span>

<span class="nc" id="L122">		return result;</span>
	}

	final public StyleSignature getStyleArrowCardinality(Stereotype stereotype) {
<span class="nc" id="L126">		StyleSignature result = StyleSignatureBasic.of(SName.root, SName.element, styleName, SName.arrow,</span>
				SName.cardinality);
<span class="nc bnc" id="L128" title="All 2 branches missed.">		if (stereotype != null)</span>
<span class="nc" id="L129">			result = result.withTOBECHANGED(stereotype);</span>

<span class="nc" id="L131">		return result;</span>
	}

	private boolean isOpalisable(Entity entity) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (dotData.getSkinParam().strictUmlStyle())</span>
<span class="nc" id="L136">			return false;</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (entity.isGroup())</span>
<span class="nc" id="L139">			return false;</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (entity.getLeafType() != LeafType.NOTE)</span>
<span class="nc" id="L142">			return false;</span>

<span class="nc" id="L144">		final Link single = onlyOneLink(entity);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (single == null)</span>
<span class="nc" id="L146">			return false;</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">		return single.getOther(entity).getLeafType() != LeafType.NOTE;</span>
	}

	static class EntityImageSimpleEmpty implements IEntityImage {

		private final HColor backColor;

<span class="nc" id="L155">		EntityImageSimpleEmpty(HColor backColor) {</span>
<span class="nc" id="L156">			this.backColor = backColor;</span>
<span class="nc" id="L157">		}</span>

		public boolean isHidden() {
<span class="nc" id="L160">			return false;</span>
		}

		public HColor getBackcolor() {
<span class="nc" id="L164">			return backColor;</span>
		}

		public XDimension2D calculateDimension(StringBounder stringBounder) {
<span class="nc" id="L168">			return new XDimension2D(10, 10);</span>
		}

		public MinMax getMinMax(StringBounder stringBounder) {
<span class="nc" id="L172">			return MinMax.fromDim(calculateDimension(stringBounder));</span>
		}

		public XRectangle2D getInnerPosition(String member, StringBounder stringBounder, InnerStrategy strategy) {
<span class="nc" id="L176">			return null;</span>
		}

		public void drawU(UGraphic ug) {
<span class="nc" id="L180">		}</span>

		public ShapeType getShapeType() {
<span class="nc" id="L183">			return ShapeType.RECTANGLE;</span>
		}

		public Margins getShield(StringBounder stringBounder) {
<span class="nc" id="L187">			return Margins.NONE;</span>
		}

		public double getOverscanX(StringBounder stringBounder) {
<span class="nc" id="L191">			return 0;</span>
		}

		@Override
		public MagneticBorder getMagneticBorder() {
<span class="nc" id="L196">			return new MagneticBorderNone();</span>
		}

	}

	// Duplicate SvekResult / GeneralImageBuilder
	private HColor getBackcolor() {
<span class="fc" id="L203">		final Style style = StyleSignatureBasic.of(SName.root, SName.document)</span>
<span class="fc" id="L204">				.getMergedStyle(dotData.getSkinParam().getCurrentStyleBuilder());</span>
<span class="fc" id="L205">		return style.value(PName.BackGroundColor).asColor(dotData.getSkinParam().getIHtmlColorSet());</span>
	}

	public IEntityImage buildImage(StringBounder stringBounder, BaseFile basefile, String dotStrings[],
			boolean fileFormatOptionIsDebugSvek) {
		// ::comment when __CORE__
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">		if (dotData.isDegeneratedWithFewEntities(0))</span>
<span class="nc" id="L212">			return new EntityImageSimpleEmpty(dotData.getSkinParam().getBackgroundColor());</span>

<span class="pc bpc" id="L214" title="2 of 4 branches missed.">		if (dotData.isDegeneratedWithFewEntities(1) &amp;&amp; dotData.getUmlDiagramType() != UmlDiagramType.STATE) {</span>
<span class="fc" id="L215">			final Entity single = dotData.getLeafs().iterator().next();</span>
<span class="fc" id="L216">			final Entity group = single.getParentContainer();</span>
<span class="pc bpc" id="L217" title="2 of 4 branches missed.">			if (group.isRoot() &amp;&amp; single.getUSymbol() instanceof USymbolHexagon == false) {</span>
<span class="fc" id="L218">				final IEntityImage tmp = GeneralImageBuilder.createEntityImageBlock(single,</span>
<span class="fc" id="L219">						dotData.isHideEmptyDescriptionForState(), dotData.getPortionShower(), null, null,</span>
<span class="fc" id="L220">						dotData.getLinks());</span>
<span class="fc" id="L221">				return new EntityImageDegenerated(tmp, getBackcolor());</span>
			}
		}
<span class="nc" id="L224">		dotData.removeIrrelevantSametail();</span>

<span class="nc" id="L226">		printGroups(stringBounder, dotData.getRootGroup());</span>
<span class="nc" id="L227">		printEntities(stringBounder, getUnpackagedEntities());</span>

<span class="nc bnc" id="L229" title="All 2 branches missed.">		for (Link link : dotData.getLinks()) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if (link.isRemoved())</span>
<span class="nc" id="L231">				continue;</span>

			try {
<span class="nc" id="L234">				final ISkinParam skinParam = dotData.getSkinParam();</span>
<span class="nc" id="L235">				final FontConfiguration labelFont = getDefaultStyleDefinitionArrow(link.getStereotype())</span>
<span class="nc" id="L236">						.getMergedStyle(link.getStyleBuilder()).getFontConfiguration(skinParam.getIHtmlColorSet());</span>
<span class="nc" id="L237">				final FontConfiguration cardinalityFont = getStyleArrowCardinality(link.getStereotype())</span>
<span class="nc" id="L238">						.getMergedStyle(link.getStyleBuilder()).getFontConfiguration(skinParam.getIHtmlColorSet());</span>

<span class="nc" id="L240">				final SvekEdge line = new SvekEdge(link, skinParam, stringBounder, labelFont, cardinalityFont,</span>
<span class="nc" id="L241">						dotStringFactory.getBibliotekon(), pragma, dotStringFactory.getGraphvizVersion());</span>

<span class="nc" id="L243">				dotStringFactory.getBibliotekon().addLine(line);</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">				if (isOpalisable(link.getEntity1())) {</span>
<span class="nc" id="L246">					final SvekNode node = dotStringFactory.getBibliotekon().getNode(link.getEntity1());</span>
<span class="nc" id="L247">					final SvekNode other = dotStringFactory.getBibliotekon().getNode(link.getEntity2());</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">					if (other != null) {</span>
<span class="nc" id="L249">						((EntityImageNote) node.getImage()).setOpaleLine(line, node, other);</span>
<span class="nc" id="L250">						line.setOpale(true);</span>
					}
<span class="nc bnc" id="L252" title="All 2 branches missed.">				} else if (isOpalisable(link.getEntity2())) {</span>
<span class="nc" id="L253">					final SvekNode node = dotStringFactory.getBibliotekon().getNode(link.getEntity2());</span>
<span class="nc" id="L254">					final SvekNode other = dotStringFactory.getBibliotekon().getNode(link.getEntity1());</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">					if (other != null) {</span>
<span class="nc" id="L256">						((EntityImageNote) node.getImage()).setOpaleLine(line, node, other);</span>
<span class="nc" id="L257">						line.setOpale(true);</span>
					}
				}
<span class="nc" id="L260">			} catch (IllegalStateException e) {</span>
<span class="nc" id="L261">				Logme.error(e);</span>
<span class="nc" id="L262">			}</span>
<span class="nc" id="L263">		}</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (dotStringFactory.illegalDotExe())</span>
<span class="nc" id="L266">			return error(dotStringFactory.getDotExe());</span>

<span class="nc bnc" id="L268" title="All 6 branches missed.">		if (basefile == null &amp;&amp; (fileFormatOptionIsDebugSvek || isSvekTrace())</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">				&amp;&amp; (SecurityUtils.getSecurityProfile() == SecurityProfile.UNSECURE</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">						|| SecurityUtils.getSecurityProfile() == SecurityProfile.LEGACY</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">						|| SecurityUtils.getSecurityProfile() == SecurityProfile.SANDBOX))</span>
<span class="nc" id="L272">			basefile = new BaseFile(null);</span>

		final String svg;
		try {
<span class="nc" id="L276">			svg = dotStringFactory.getSvg(stringBounder, dotMode, basefile, dotStrings);</span>
<span class="nc" id="L277">		} catch (IOException e) {</span>
<span class="nc" id="L278">			return GraphvizCrash.build(source.getPlainString(BackSlash.lineSeparator()),</span>
<span class="nc" id="L279">					GraphvizRuntimeEnvironment.getInstance().graphviz244onWindows(), e);</span>
<span class="nc" id="L280">		}</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">		if (svg.length() == 0)</span>
<span class="nc" id="L282">			return GraphvizCrash.build(source.getPlainString(BackSlash.lineSeparator()),</span>
<span class="nc" id="L283">					GraphvizRuntimeEnvironment.getInstance().graphviz244onWindows(), new EmptySvgException());</span>

<span class="nc" id="L285">		final String graphvizVersion = extractGraphvizVersion(svg);</span>
		try {
<span class="nc" id="L287">			dotStringFactory.solve(svg);</span>
<span class="nc" id="L288">			final SvekResult result = new SvekResult(dotData, dotStringFactory);</span>
<span class="nc" id="L289">			this.maxX = dotStringFactory.getBibliotekon().getMaxX();</span>
<span class="nc" id="L290">			return result;</span>
<span class="nc" id="L291">		} catch (Exception e) {</span>
<span class="nc" id="L292">			Log.error(&quot;Exception &quot; + e);</span>
<span class="nc" id="L293">			throw new UnparsableGraphvizException(e, graphvizVersion, svg,</span>
<span class="nc" id="L294">					source.getPlainString(BackSlash.lineSeparator()));</span>
		}
		// ::done
		// ::uncomment when __CORE__
		// return null;
		// ::done

	}

	private boolean isSvekTrace() {
<span class="nc" id="L304">		final String value = pragma.getValue(PragmaKey.SVEK_TRACE);</span>
<span class="nc bnc" id="L305" title="All 4 branches missed.">		return &quot;true&quot;.equalsIgnoreCase(value) || &quot;on&quot;.equalsIgnoreCase(value);</span>
	}

	private String extractGraphvizVersion(String svg) {
<span class="nc" id="L309">		final Pattern pGraph = Pattern.compile(&quot;(?mi)!-- generated by graphviz(.*)&quot;);</span>
<span class="nc" id="L310">		final Matcher mGraph = pGraph.matcher(svg);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (mGraph.find())</span>
<span class="nc" id="L312">			return StringUtils.trin(mGraph.group(1));</span>

<span class="nc" id="L314">		return null;</span>
	}

	private Link onlyOneLink(Entity ent) {
<span class="nc" id="L318">		Link single = null;</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">		for (Link link : dotData.getLinks()) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">			if (link.isInvis())</span>
<span class="nc" id="L321">				continue;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">			if (link.contains(ent) == false)</span>
<span class="nc" id="L323">				continue;</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">			if (single != null)</span>
<span class="nc" id="L326">				return null;</span>
<span class="nc" id="L327">			single = link;</span>
<span class="nc" id="L328">		}</span>
<span class="nc" id="L329">		return single;</span>
	}

	// ::comment when __CORE__
	private IEntityImage error(File dotExe) {
<span class="nc" id="L334">		final List&lt;String&gt; msg = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L335">		msg.add(&quot;Dot Executable: &quot; + dotExe);</span>
<span class="nc" id="L336">		final ExeState exeState = ExeState.checkFile(dotExe);</span>
<span class="nc" id="L337">		msg.add(exeState.getTextMessage());</span>
<span class="nc" id="L338">		msg.add(&quot;Cannot find Graphviz. You should try&quot;);</span>
<span class="nc" id="L339">		msg.add(&quot; &quot;);</span>
<span class="nc" id="L340">		msg.add(&quot;@startuml&quot;);</span>
<span class="nc" id="L341">		msg.add(&quot;testdot&quot;);</span>
<span class="nc" id="L342">		msg.add(&quot;@enduml&quot;);</span>
<span class="nc" id="L343">		msg.add(&quot; &quot;);</span>
<span class="nc" id="L344">		msg.add(&quot; or &quot;);</span>
<span class="nc" id="L345">		msg.add(&quot; &quot;);</span>
<span class="nc" id="L346">		msg.add(&quot;java -jar plantuml.jar -testdot&quot;);</span>
<span class="nc" id="L347">		msg.add(&quot; &quot;);</span>
<span class="nc" id="L348">		return GraphicStrings.createForError(msg, false);</span>
	}
	// ::done

	private void printEntities(StringBounder stringBounder, Collection&lt;Entity&gt; entities2) {
<span class="nc bnc" id="L353" title="All 2 branches missed.">		for (Entity ent : entities2) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">			if (ent.isRemoved())</span>
<span class="nc" id="L355">				continue;</span>

<span class="nc" id="L357">			printEntity(stringBounder, ent);</span>
<span class="nc" id="L358">		}</span>
<span class="nc" id="L359">	}</span>

	private void printEntity(StringBounder stringBounder, Entity ent) {
<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (ent.isRemoved())</span>
<span class="nc" id="L363">			throw new IllegalStateException(ent.toString());</span>

<span class="nc" id="L365">		final IEntityImage image = printEntityInternal(stringBounder, ent);</span>
<span class="nc" id="L366">		final SvekNode node = dotStringFactory.getBibliotekon().createNode(ent, image, stringBounder);</span>
<span class="nc" id="L367">		clusterManager.addNode(node);</span>
<span class="nc" id="L368">	}</span>

	private IEntityImage printEntityInternal(StringBounder stringBounder, Entity ent) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">		if (ent.isRemoved())</span>
<span class="nc" id="L372">			throw new IllegalStateException();</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (ent.getSvekImage() == null) {</span>
<span class="nc" id="L375">			ISkinParam skinParam = dotData.getSkinParam();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">			if (skinParam.sameClassWidth()) {</span>
<span class="nc" id="L377">				final double width = getMaxWidth(stringBounder);</span>
<span class="nc" id="L378">				((SkinParam) skinParam).setParamSameClassWidth(width);</span>
			}

<span class="nc" id="L381">			return GeneralImageBuilder.createEntityImageBlock(ent, dotData.isHideEmptyDescriptionForState(),</span>
<span class="nc" id="L382">					dotData.getPortionShower(), dotStringFactory.getBibliotekon(),</span>
<span class="nc" id="L383">					dotStringFactory.getGraphvizVersion(), dotData.getLinks());</span>
		}
<span class="nc" id="L385">		return ent.getSvekImage();</span>
	}

	private double getMaxWidth(StringBounder stringBounder) {
<span class="nc" id="L389">		double result = 0;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">		for (Entity ent : dotData.getLeafs()) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">			if (ent.getLeafType().isLikeClass() == false)</span>
<span class="nc" id="L392">				continue;</span>

<span class="nc" id="L394">			final IEntityImage im = new EntityImageClass(ent, dotData.getPortionShower());</span>
<span class="nc" id="L395">			final double w = im.calculateDimension(stringBounder).getWidth();</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">			if (w &gt; result)</span>
<span class="nc" id="L397">				result = w;</span>

<span class="nc" id="L399">		}</span>
<span class="nc" id="L400">		return result;</span>
	}

	private Collection&lt;Entity&gt; getUnpackagedEntities() {
<span class="nc" id="L404">		final List&lt;Entity&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">		for (Entity ent : dotData.getLeafs())</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">			if (dotData.getTopParent() == ent.getParentContainer())</span>
<span class="nc" id="L407">				result.add(ent);</span>

<span class="nc" id="L409">		return result;</span>
	}

	private void printGroups(StringBounder stringBounder, Entity parent) {
		// System.err.println(&quot;PARENT=&quot; + parent);
<span class="nc" id="L414">		final Collection&lt;Entity&gt; groups = dotData.getGroupHierarchy().getChildrenGroups(parent);</span>
		// System.err.println(&quot;groups=&quot; + groups);
<span class="nc bnc" id="L416" title="All 2 branches missed.">		for (Entity g : groups) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">			if (g.isRemoved())</span>
<span class="nc" id="L418">				continue;</span>

<span class="nc bnc" id="L420" title="All 4 branches missed.">			if (dotData.isEmpty(g) &amp;&amp; g.getGroupType() == GroupType.PACKAGE) {</span>
<span class="nc" id="L421">				g.muteToType(LeafType.EMPTY_PACKAGE);</span>
<span class="nc" id="L422">				printEntity(stringBounder, g);</span>
			} else {
<span class="nc" id="L424">				printGroup(stringBounder, g);</span>
			}
<span class="nc" id="L426">		}</span>
<span class="nc" id="L427">	}</span>

	private void printGroup(StringBounder stringBounder, Entity g) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">		if (g.getGroupType() == GroupType.CONCURRENT_STATE)</span>
<span class="nc" id="L431">			return;</span>

<span class="nc" id="L433">		final ClusterHeader clusterHeader = new ClusterHeader(g, dotData.getPortionShower(), stringBounder);</span>
<span class="nc" id="L434">		clusterManager.openCluster(g, clusterHeader);</span>
<span class="nc" id="L435">		this.printEntities(stringBounder, g.leafs());</span>

<span class="nc" id="L437">		printGroups(stringBounder, g);</span>

<span class="nc" id="L439">		clusterManager.closeCluster();</span>
<span class="nc" id="L440">	}</span>

	public String getWarningOrError(int warningOrError) {
<span class="nc bnc" id="L443" title="All 2 branches missed.">		if (maxX == null)</span>
<span class="nc" id="L444">			return &quot;&quot;;</span>

<span class="nc" id="L446">		final StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">		for (Map.Entry&lt;String, Double&gt; ent : maxX.entrySet())</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">			if (ent.getValue() &gt; warningOrError) {</span>
<span class="nc" id="L449">				sb.append(ent.getKey() + &quot; is overpassing the width limit.&quot;);</span>
<span class="nc" id="L450">				sb.append(&quot;\n&quot;);</span>
			}

<span class="nc bnc" id="L453" title="All 2 branches missed.">		return sb.length() == 0 ? &quot;&quot; : sb.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>